<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Words Game</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .container {
            display: flex;
            justify-content: space-between;
            margin: 20px;
        }

        .box {
            width: 30%;
            padding: 10px;
            border: 1px solid #000;
            margin: 5px;
            box-sizing: border-box;
        }

        .box-large {
            width: 65%;
        }

    </style>
</head>
<body>
<h1> Match words </h1>
<p id="counter"></p>

<div class="container">
    <p> 1 </p>
    <div class="box" id="word-0" onclick="selectWord(0)"></div>
    <p> a </p>
    <div class="box box-large" id="explanation-0" onclick="selectExplanation(0)"></div>
</div>
<div class="container">
    <p> 2 </p>
    <div class="box" id="word-1" onclick="selectWord(1)"></div>
    <p> b </p>
    <div class="box box-large" id="explanation-1" onclick="selectExplanation(1)"></div>
</div>
<div class="container">
    <p> 3 </p>
    <div class="box" id="word-2" onclick="selectWord(2)"></div>
    <p> c </p>
    <div class="box box-large" id="explanation-2" onclick="selectExplanation(2)"></div>
</div>
<div class="container">
    <p> 4 </p>
    <div class="box" id="word-3" onclick="selectWord(3)"></div>
    <p> d </p>
    <div class="box box-large" id="explanation-3" onclick="selectExplanation(3)"></div>
</div>
<script>

    let completed = sessionStorage.getItem('completed_tasks') || 0;
    document.getElementById('counter').textContent = `Task №: ${completed}`;

    let selectedWord = null;
    let selectedExplanation = null;

    const task = JSON.parse(sessionStorage.getItem('task_content'));
    const data = [
        {word: task.word1, explanation: task.explanation1, matched: false},
        {word: task.word2, explanation: task.explanation2, matched: false},
        {word: task.word3, explanation: task.explanation3, matched: false},
        {word: task.word4, explanation: task.explanation4, matched: false}
    ];


    function chooseAnswerKey(e) {

        if (e.key === '1') {
            // call your function to do the thing
            selectWord(0);
        } else if (e.key === '2') {
            // call your function to do the thing
            selectWord(1);
        } else if (e.key === '3') {
            // call your function to do the thing
            selectWord(2);
        } else if (e.key === '4') {
            // call your function to do the thing
            selectWord(3);
        } else if (e.key === 'a' || e.key === 'A' || e.key === 'ф' || e.key === 'Ф') {
            // call your function to do the thing
            selectExplanation(0);
        } else if (e.key === 'b' || e.key === 'B' || e.key === 'и' || e.key === 'И') {
            // call your function to do the thing
            selectExplanation(1);
        } else if (e.key === 'c' || e.key === 'C' || e.key === 'с' || e.key === 'С') {
            // call your function to do the thing
            selectExplanation(2);
        } else if (e.key === 'd' || e.key === 'D' || e.key === 'в' || e.key === 'в') {
            // call your function to do the thing
            selectExplanation(3);
        }
    }
    document.addEventListener("keydown", chooseAnswerKey);

    let box2word = [0, 1, 2, 3].sort(() => Math.random() - 0.5);
    let box2explanation = [0, 1, 2, 3].sort(() => Math.random() - 0.5);
    updateView();

    function flashElement(element) {
        const flashCount = 3; // Set the number of times to flash
        for (let i = 0; i < flashCount; i++) {
            setTimeout(() => {
                element.style.backgroundColor = (i % 2 === 0) ? 'red' : 'white';
            }, i * 300); // Change the timing as needed
        }
        setTimeout(() => {
            element.style.backgroundColor = 'white'; // Ensure it ends as white
        }, flashCount * 300);
    }

    function getNewTask() {
        window.location.replace("/static/task_experimental.html");
    }

    function updateView() {
        for (let i = 0; i < box2word.length; i++) {
            const wordBox = document.getElementById(`word-${i}`);
            const explanationBox = document.getElementById(`explanation-${i}`);

            const wordId = box2word[i];
            const explanationId = box2explanation[i];
            wordBox.textContent = data[wordId].word;
            explanationBox.innerHTML = data[explanationId].explanation;
            if (data[wordId].matched) {
                wordBox.style.backgroundColor = 'green';
                explanationBox.style.backgroundColor = 'green';
            } else {
                wordBox.style.backgroundColor = 'white';
                explanationBox.style.backgroundColor = 'white';
            }
        }

        if (data.every(item => item.matched)) {
            setTimeout(getNewTask, 200);
        }

    }

    function match() {
        const wordId = box2word[selectedWord];
        const explanationId = box2explanation[selectedExplanation];
        if (wordId === explanationId) {
            const wordBox = document.getElementById(`word-${selectedWord}`);
            const explanationBox = document.getElementById(`explanation-${selectedExplanation}`);
            wordBox.style.backgroundColor = 'green';
            explanationBox.style.backgroundColor = 'green';
            data[wordId]["matched"] = true;
            const word = data[wordId].word;
            data[wordId].explanation = data[wordId].explanation.replace("***", `<b>${word}</b>`);

            selectedWord = null;
            selectedExplanation = null;

            box2word = box2word.sort((a, b) => data[a]["matched"] - data[b]["matched"]);
            box2explanation = box2explanation.sort((a, b) => data[a]["matched"] - data[b]["matched"]);
            setTimeout(updateView, 200);

            return true;
        } else {
            return false;
        }
    }

    function selectWord(id) {
        // check if already matched
        if (data[box2word[id]].matched) {
            // nothing to do
            return;
        }

        const newElement = document.getElementById(`word-${id}`);
        if (selectedWord === id) {
            // unselect
            newElement.style.backgroundColor = 'white';
            selectedWord = null;
            return;
        }
        if (selectedWord !== null) {
            const oldElement = document.getElementById(`word-${selectedWord}`);
            oldElement.style.backgroundColor = 'white';
        }
        selectedWord = id;
        newElement.style.backgroundColor = 'lightgray';

        if (selectedExplanation !== null) {
            const matched = match();
            if (!matched) {
                selectedWord = null;
                flashElement(newElement);
                newElement.style.backgroundColor = 'white';
            }
        }
    }


    function selectExplanation(id) {
        if (data[box2explanation[id]].matched) {
            // nothing to do
            return;
        }
        const newElement = document.getElementById(`explanation-${id}`);
        if (selectedExplanation === id) {
            // unselect
            newElement.style.backgroundColor = 'white';
            selectedExplanation = null;
            return;
        }
        if (selectedExplanation !== null) {
            const oldElement = document.getElementById(`explanation-${selectedExplanation}`);
            oldElement.style.backgroundColor = 'white';
        }
        selectedExplanation = id;
        newElement.style.backgroundColor = 'lightgray';

        if (selectedWord !== null) {
            const matched = match();
            if (!matched) {
                selectedExplanation = null;
                flashElement(newElement);
                newElement.style.backgroundColor = 'white';
            }
        }
    }


</script>
</body>
</html>